# Project Guidelines for Claude

## Workflow

**Start of every conversation:**
- ALWAYS read this file (`CLAUDE.md`) first to get up-to-date project context and guidelines.

**End of every task:**
- Check if `README.md` and `CLAUDE.md` need updates (architecture changes, file organization, commands, testing, tech stack).
- Run tests with `bun test` after code changes.
- Update documentation immediately if changes affect project structure or conventions.

## Critical Rules (Most Important)

1. **Styling**: TailwindCSS ONLY. Never use `sx` props, inline `style`, or create `.css` files (exception: `theme.ts`).
2. **Imports**: Always use `@/` for src files (e.g., `@/components/Header`). Use relative paths only within `__tests__/` for test imports.
3. **Server Functions**: All server logic via `createServerFn()` + middleware injection. Never create clients directly.
4. **Streaming Pattern**: Server functions → `useServerStream` → `StreamingTable`. Never use raw `useEffect` + `for await`.
5. **File Creation**: PREFER editing existing files over creating new ones. Only create files when genuinely necessary.
6. **Testing**: Tests in `__tests__/` folders co-located with source. Use `bun:test` imports.
7. **No Logging**: No `console.log` in committed code. Only `console.error` for actual errors.

## Tech Stack

- **Framework:** TanStack Start (SPA mode, SSR disabled)
- **Runtime:** Bun (package manager, test runner, runtime)
- **Language:** TypeScript (strict mode) + React 19
- **UI:** MUI Joy UI (components) + TailwindCSS (styling)
- **Routing:** TanStack Router (file-based, auto-generated `routeTree.gen.ts`)
- **State:** TanStack Query (QueryClient singleton in `__root.tsx`)
- **Streaming:** Server functions via `createServerFn()` with async generators
- **Clients:** Dockerode (Docker API), ssh2 (SSH)
- **Validation:** Zod
- **Testing:** Bun test (`bun:test`)

## Commands

```bash
bun dev                     # Dev server (port 3000)
bun build                   # Production build
bun test                    # Run all tests
bun test --watch            # Watch mode
bun run test:coverage       # Run tests with coverage report
bun run test:coverage:check # Run tests and enforce 90% coverage threshold
```

## File Organization

```
src/
├── components/
│   ├── shared-table/        # StreamingTable, MetricCell (shared infrastructure)
│   ├── docker/              # Docker-specific components
│   ├── zfs/                 # ZFS-specific components
│   ├── settings/            # Settings form and section components
│   └── [AppShell, Header, ModeToggle, ThemeProvider]
├── hooks/                   # Custom hooks (useServerStream, etc.)
├── data/                    # Server functions (*.functions.tsx)
├── middleware/              # Connection injection (Docker, SSH)
├── lib/
│   ├── __tests__/           # Unit tests (*.test.ts)
│   ├── clients/             # Connection managers (Docker, SSH)
│   ├── parsers/             # Stream parsers
│   ├── test/                # Test utilities (NOT in __tests__)
│   ├── utils/               # Rate calculators, hierarchy builders
│   ├── validation/          # Zod schemas (settings, etc.)
│   └── streaming/types.ts   # Core interfaces
├── types/                   # Domain types (docker.ts, zfs.ts, settings.ts)
├── formatters/              # Display formatting (metrics, numbers)
└── routes/                  # TanStack Router pages
```

## Architecture Patterns

### Routing
- **Never edit** `routeTree.gen.ts` (auto-generated by TanStack Router).
- Root route (`__root.tsx`) has ONLY `shellComponent` (plain HTML). NO `component` prop — SSR breaks MUI Joy.
- Client-side layout lives in `AppShell.tsx`. Each route wraps content with `<AppShell>`.
- All routes: `ssr: false` (SPA mode).

### Server Functions & Streaming
- All server logic: `createServerFn()` from `@tanstack/react-start`.
- Connection injection via middleware (never create Docker/SSH clients in server functions).
- Streaming: async generator functions (`async function*`).
- Data flow: Server function → `useServerStream` hook → `StreamingTable` component.

### Streaming Data Sources (Factory Pattern)
When adding a new streaming data source:
1. Create server function (async generator)
2. Define column config
3. Create `onData` reducer (how to merge new data)
4. Create row renderer component
5. Pass all to `StreamingTable`

Rate calculators:
- Must implement `RateCalculator<TInput, TOutput>` interface (`src/lib/streaming/types.ts`)
- Use class-based calculators (not module-level functions)

### Components
- Shared table infrastructure: `src/components/shared-table/` (MetricCell, StreamingTable)
- Domain components: own directories (`docker/`, `zfs/`)
- Extract repeated patterns into reusable components (e.g., `ZFSMetricCells`)
- NO dashboard wrapper components — `StreamingTable` handles title + sheet + table + loading/error

### Styling
- **TailwindCSS only** for all layout and styling
- Never use MUI `sx` props (use Tailwind: `p-3` not `sx={{ p: 3 }}`)
- Never use inline `style` attribute
- Never create `.css` files (exception: Joy UI theme in `theme.ts`)

### State Management
- `QueryClient` is a singleton in `__root.tsx` — never create per-route
- Use `useServerStream` for consuming streaming server functions
- Never duplicate streaming logic with raw `useEffect` + `for await`

### Types
- Domain types: `src/types/` (e.g., `docker.ts`, `zfs.ts`)
- Streaming infrastructure: `src/lib/streaming/types.ts`

### Testing
- Test files: `__tests__/` folders co-located with source
- Naming: `*.test.ts` or `*.test.tsx`
- Test utilities: separate directories (e.g., `src/lib/test/`), NOT in `__tests__/`
- Use `bun:test` imports: `import { describe, it, expect } from 'bun:test'`
- **Coverage requirements:** 93% lines, 93% functions (automatically enforced by `bun test`)
- `bun test` automatically checks coverage and fails if below threshold

### Imports
- **Always use `@/` for project imports**: `import { Header } from '@/components/Header'`
- Relative paths OK for test imports in `__tests__/`: `import { foo } from '../foo'`
- Never mix `@/` and relative in the same file (except tests)

## Decision Frameworks

### When to Create a New File
**Create:** New feature/component with distinct responsibility
**Edit:** Modifying or extending existing functionality

### When to Use Middleware
**Use:** Connection injection (Docker, SSH, HTTP clients) and cross-cutting concerns
**Don't:** Business logic (server functions) or component logic (hooks/components)

### When to Extract a Component
**Extract:** Repeated 3+ times OR clear reusable abstraction
**Don't:** One-off use or requires excessive props to function

## CI/CD & Code Review

### Branch Protection
- All changes to `main` must go through a pull request — direct pushes are blocked.
- PRs require passing CI status checks (build, test, coverage, license) before merging.
- PRs by `jaredglaser` or `claude[bot]` receive an automatic Claude code review via the `claude-review.yml` workflow.

### GitHub Actions Workflows
| Workflow | File | Triggers |
|----------|------|----------|
| **CI** | `.github/workflows/ci.yml` | Push to `main`, PRs targeting `main` |
| **Claude PR Review** | `.github/workflows/claude-review.yml` | PRs targeting `main` (opened, synchronize, ready_for_review, reopened) |
| **Claude Code** | `.github/workflows/claude.yml` | `@claude` mentions in issues, PR comments, and PR reviews |

## Security & Best Practices

- Never log environment variables or sensitive config
- Validate all external input with Zod
- Never commit debugging code (`console.log`)
- Use `console.error` only for actual errors
- Prefer type safety over runtime checks where possible

## Anti-Patterns (DO NOT)

- MUI `sx` props for styling (use Tailwind)
- Inline `style` attributes (use Tailwind)
- Creating `.css` files (use Tailwind)
- Manual edits to `routeTree.gen.ts` (auto-generated)
- Adding `component` to root route (breaks SSR)
- Creating QueryClient per route (singleton only)
- Creating clients in server functions (use middleware)
- Raw `useEffect` + `for await` (use `useServerStream`)
- Dashboard wrapper components (use `StreamingTable`)
- Test files outside `__tests__/` folders
- `console.log` in committed code
- Logging sensitive data

## Quick Reference

| Need | Solution |
|------|----------|
| Style component | TailwindCSS classes |
| Server logic | `createServerFn()` + middleware |
| Consume stream | `useServerStream` hook |
| New streaming table | `StreamingTable` factory |
| Import from src | `@/path/to/file` |
| Test file location | `__tests__/filename.test.ts` |
| Run tests | `bun test` |
| Type validation | Zod schema |
